name: Docker Setup Test
on: [push]
# on:
#   merge_group:
#     types: [checks_requested]
#   push:
#     branches:
#       - develop
#       - release-*
#   pull_request:
#     branches:
#       - develop
#       - release-*


jobs:
  docker-setup:
    runs-on:  ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04]
        repeat: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50]
    steps:
      - name: Checkout to the Oppia repository code
        uses: actions/checkout@v3

      - uses: ./.github/actions/merge

      - name: Build Images
        run: |
          echo ---Building Docker Images---
          docker compose build
          
      - name: Start Containers
        run: |
          echo ---Starting Containers---
          docker compose up -d

      - name: Checking server reachability
        run: |
          for i in {1..5}; do
            if curl -s http://localhost:8181/; then
              echo ---Dev-server is up---
              exit 0
            else
              echo ---Retrying in 5mins---
              sleep 300
            fi
          done
          echo ---Dev-server is not started after all retries---
          exit 1
          
      - name: Stop Containers
        run: docker compose down
